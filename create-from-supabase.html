<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>QR Codes for All JVP Students</title>
      <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
      <!-- Supabase CRUD Functions -->
      <script type="module" src="https://sourabhsuneja.github.io/redirect/jvp-marks-management/supabase-crud.js"></script>
      <style>
         * {
         max-height: 999999999px;
         }
         body {
         font-family: Arial, sans-serif;
         margin: 0;
         padding: 20px;
         background-color: #f9f9f9;
         color: #333;
         }
         h1 {
         text-align: center;
         margin-bottom: 20px;
         color: #333;
         }
         #qr-grid {
         display: grid;
         grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
         gap: 20px;
         margin-top: 20px;
         }
         .qr-card {
         background: #fff;
         padding: 15px;
         border-radius: 10px;
         box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
         text-align: center;
         }
         .qr-label {
         margin-top: 10px;
         font-size: 14px;
         color: #000;
         }
         .qr-label h2 {
         margin: 4px 0;
         padding: 0;
         font-size: 15px;
         color: #000;
         }
         .qr-label strong {
         margin-top: 6px;
         display: block;
         }
         button {
         display: inline-block;
         margin: 10px auto;
         padding: 10px 20px;
         font-size: 16px;
         color: #fff;
         background-color: #4CAF50;
         border: none;
         border-radius: 5px;
         cursor: pointer;
         transition: background-color 0.3s ease;
         }
         button:hover {
         background-color: #45a049;
         }
         #print-btn {
         margin-top: 30px;
         }
         .center-text {
         font-size: 50px;
         font-weight: bold;
         color: #4CAF50;
         text-align: center;
         animation: pulse 1.2s infinite;
         position: absolute;
         top: 50%;
         left: 50%;
         transform: translate(-50%, -50%);
         }
         @keyframes pulse {
         0% {
         transform: translate(-50%, -50%) scale(1);
         }
         50% {
         transform: translate(-50%, -50%) scale(1.2);
         }
         100% {
         transform: translate(-50%, -50%) scale(1);
         }
         }
         @media print {
               button, h1 {
                   display: none;
               }
               html, body, #qr-grid {
                   padding: 0;
                   margin: 0;
               }
         }
      </style>
   </head>
   <body>
      <h1>QR Codes for All JVP Students</h1>
      <div id="qr-grid"></div>
      <button style="display: none" id="print-btn" onclick="printPage()">Print QR Codes</button>
      <div id="generating-text" class="center-text">
         Generating
      </div>
      <script>
         let data = [];
         
         function generateAllQRCodes() {
             const qrGrid = document.getElementById('qr-grid');
         
             data.forEach((item) => {
                 const qrCard = document.createElement('div');
                 qrCard.className = 'qr-card';
         
                 const canvas = document.createElement('canvas');
                 const label = document.createElement('div');
                 label.className = 'qr-label';
         
                 // Prepare label text
                 const labelText = `<h2>Student Details</h2>Name: ${capitalizeFirstLetter(item.name)}, Class: ${item.class}<br><strong>Paste this QR code in your diary.</strong>`;
                 label.innerHTML = labelText;
         
                 // Generate QR code
                 const qrData = String(item.access_token);
                 QRCode.toCanvas(canvas, qrData, { width: 200 }, (error) => {
                     if (error) console.error(error);
                 });
         
                 // Append canvas and label to card
                 qrCard.appendChild(canvas);
                 qrCard.appendChild(label);
         
                 // Add card to grid
                 qrGrid.appendChild(qrCard);
             });
         }
         
         function printPage() {
             window.print();
         }
         
      </script>
      <script>      
          function capitalizeFirstLetter(string) {
          return string
          .toLowerCase() // Convert the entire string to lowercase
          .split(' ') // Split the string into an array of words
          .map(word => word.charAt(0).toUpperCase() + word.slice(1)) // Capitalize the first letter of each word
          .join(' '); // Join the array of words back into a single string
          }
         
          window.onload = async function () {
   try {
      // First, fetch ordered by class
      data = await selectData(
         "students",
         false, // fetchSingle
         "name, class, access_token",
         [], // matchColumns
         [], // matchValues
         "class", // orderByColumn
         "asc", // orderDirection
         [] // customFilters
      );

      // Now, sort the result by name (second level sort)
      if (data) {
         data.sort((a, b) => {
            // First compare by class (redundant here since already ordered by class)
            if (a.class < b.class) return -1;
            if (a.class > b.class) return 1;

            // Then compare by name
            return a.name.localeCompare(b.name);
         });

         console.log("Fetched Students:", data);
         generateAllQRCodes();
      }
   } catch (err) {
      console.error("Failed to fetch student data:", err);
   }
};

      </script>
      
   </body>
</html>
